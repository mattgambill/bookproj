import json
import urllib.parse
import requests
import csv 
import isbnlib as il

errorList = []
errorList2 = []
imgList = []
numErrors = 0
api = 'https://www.googleapis.com/books/v1/volumes?q=isbn:'

# read isbn data

with open('books.csv', 'r') as f:
	fin = csv.reader(f)
	isbnList = []
	for row in fin:
		if len (row) != 0:
			isbnList = isbnList + [row]
f.close()

#google books api

for i  in range(len(isbnList)):
	url = api + isbnList[i][0]
	print('\n \n \n ')	
	print(url)
	print('\n ')
	res = requests.get(url).json();
	#print(res)
	#print('\n \n \n ')
	try:
		items = res["items"];
		bookInfo = items[0]["volumeInfo"];
		print(bookInfo)
		with open("output.csv", "a") as f:
			fout = csv.writer(f)
			fout.writerow([bookInfo["title"], bookInfo["authors"][0], isbnList[i][0], bookInfo["pageCount"]])
		f.close()
	except Exception:
		#print("ERROR FOR ISBN: ")
		#print(isbnList[i][0])
                
		numErrors = numErrors + 1
		errorList.append(isbnList[i][0])
		continue


for j in range(len(errorList)):
        print(j)	
        errorList[j] = il.meta(errorList[j])


print(errorList)

for k in range(len(errorList)):
        try:
                with open("output.csv","a") as f:
                        fout = csv.writer(f)
                        fout.writerow([errorList[k]["Title"],errorList[k]["Authors"][0],errorList[k]["ISBN-13"]])
                        f.close()
        except Exception:
                errorList2.append(errorList[k])
                print(errorList2)
                

print("\nOutput is in current folder and is named output.csv \n")


